<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=5">

    <title>CS437 Hydration Tracker</title>
    <link rel="shortcut icon" href="favicon.ico" type="image/x-icon">

    <link rel="apple-touch-icon" href="icons/apple-icon-180.png">

    <meta name="apple-mobile-web-app-capable" content="yes">

    <link rel="apple-touch-startup-image" href="icons/apple-splash-2048-2732.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-2732-2048.jpg" media="(device-width: 1024px) and (device-height: 1366px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-1668-2388.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-2388-1668.jpg" media="(device-width: 834px) and (device-height: 1194px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-1536-2048.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-2048-1536.jpg" media="(device-width: 768px) and (device-height: 1024px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-1668-2224.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-2224-1668.jpg" media="(device-width: 834px) and (device-height: 1112px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-1620-2160.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-2160-1620.jpg" media="(device-width: 810px) and (device-height: 1080px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-1284-2778.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-2778-1284.jpg" media="(device-width: 428px) and (device-height: 926px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-1170-2532.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-2532-1170.jpg" media="(device-width: 390px) and (device-height: 844px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-1125-2436.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-2436-1125.jpg" media="(device-width: 375px) and (device-height: 812px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-1242-2688.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-2688-1242.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-828-1792.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-1792-828.jpg" media="(device-width: 414px) and (device-height: 896px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-1242-2208.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-2208-1242.jpg" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-750-1334.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-1334-750.jpg" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-640-1136.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: portrait)">
    <link rel="apple-touch-startup-image" href="icons/apple-splash-1136-640.jpg" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2) and (orientation: landscape)">

    <link rel="manifest" href="manifest.json">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css" integrity="sha384-HSMxcRTRxnN+Bdg0JdbxYKrThecOKuH5zCYotlSAcp1+c8xmyTe9GYg1l9a69psu" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap-theme.min.css" integrity="sha384-6pzBo3FDv/PJ8r2KRkGHifhEocL+1X2rVCTTkUfGk7/0pbek5mMa1upzvWbrUbOZ" crossorigin="anonymous">


    <!-- custom CSS file -->
    <link href="homepage.css" rel="stylesheet">

    <!-- chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
  </head>
  <body>

    <nav class="navbar navbar-inverse navbar-fixed-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false" aria-controls="navbar">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="/">CS 437 Hydration Tracker</a>
        </div>
        <div id="navbar" class="navbar-collapse collapse">
          <ul class="nav navbar-nav navbar-right">
            <li><a href="/">Dashboard</a></li>
            <li><a href="/settings">Settings</a></li>
          </ul>
        </div>
      </div>
    </nav>

    <div class="container-fluid">
      <div class="row">
        <div class="col-sm-9 col-sm-offset-3 col-md-10 col-md-offset-0 main">
          <h1 class="page-header">Dashboard</h1>

          <div class="row placeholders">
            <div class="col-xs-6 col-sm-3 placeholder">
              <h4>Daily Consumption</h4>
              <canvas id="chart1" width="400" height="400"></canvas>
              <script>
                  function renderDaily(response) {
                    const ctx1 = document.getElementById('chart1').getContext('2d');
                    const myChart1 = new Chart(ctx1, {
                        type: 'line',
                        data: {
                            labels: response.labels,
                            datasets: [{
                              label: 'Water Consumption (ml)',
                              data: response.data,
                              fill: false,
                              borderColor: 'rgb(75, 192, 192)',
                              tension: 0.1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });

                    document.getElementById('chart1_label').innerText = `You consumed ${response.total}${response.unit} of water today`;
                  }
                  fetch('/api/daily')
                  .then(response => response.json())
                  .then(response => {
                    renderDaily(response);
                    oldResponses['daily'] = JSON.stringify(response);
                  });

              </script>
              <span id="chart1_label" class="text-muted">Loading...</span>
            </div>
            <div class="col-xs-6 col-sm-3 placeholder">
              <h4>Weekly Consumption</h4>
              <canvas id="chart2" width="400" height="400"></canvas>
              <script>
                  function renderWeekly(response) {
                    const ctx2 = document.getElementById('chart2').getContext('2d');
                    const myChart2 = new Chart(ctx2, {
                      type: 'line',
                        data: {
                            labels: response.labels,
                            datasets: [{
                              label: 'Water Consumption (ml)',
                              data: response.data,
                              fill: false,
                              borderColor: 'rgb(75, 192, 192)',
                              tension: 0.1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    document.getElementById('chart2_label').innerText = `You consumed ${response.total}${response.unit} this week`;
                  }
                  fetch('/api/weekly')
                  .then(response => response.json())
                  .then(response => {
                    renderWeekly(response)
                    oldResponses['weekly'] = JSON.stringify(response);
                  });
              </script>
              <span id="chart2_label" class="text-muted">Loading...</span>
            </div>
          </div>
          <div class="row placeholders">
            <div class="col-xs-6 col-sm-3 placeholder">
              <h4>Monthly Consumption</h4>
              <canvas id="chart3" width="400" height="400"></canvas>
              <script>
                  function renderMonthly(response) {
                    const ctx3 = document.getElementById('chart3').getContext('2d');
                    const myChart3 = new Chart(ctx3, {
                      type: 'line',
                        data: {
                            labels: response.labels,
                            datasets: [{
                              label: 'Water Consumption (l)',
                              data: response.data,
                              fill: false,
                              borderColor: 'rgb(75, 192, 192)',
                              tension: 0.1
                            }]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    document.getElementById('chart3_label').innerText = `You consumed ${response.total}${response.unit} this month`;
                  }
                  fetch('/api/monthly')
                  .then(response => response.json())
                  .then(response => {
                    renderMonthly(response)
                    oldResponses['monthly'] = JSON.stringify(response);
                  });
              </script>
              <span id="chart3_label" class="text-muted">Loading...</span>
            </div>
            <div class="col-xs-6 col-sm-3 placeholder">
              <h4>Environmental Conditions</h4>
              <canvas id="chart4" width="400" height="400"></canvas>
              <script>

                  function renderEnvironment(response) {
                    const ctx4 = document.getElementById('chart4').getContext('2d');
                    const myChart4 = new Chart(ctx4, {
                      type: 'line',
                        data: {
                            labels: response.labels,
                            datasets: [
                            {
                              label: 'Humidity %',
                              data: response.data_humid,
                              fill: false,
                              borderColor: 'rgb(75, 192, 192)',
                              tension: 0.1
                            },
                            {
                              label: 'Temperature (°f)',
                              data: response.data_temp,
                              fill: false,
                              borderColor: 'rgb(255,165,0)',
                              tension: 0.1
                            }
                          ]
                        },
                        options: {
                            scales: {
                                y: {
                                    beginAtZero: true
                                }
                            }
                        }
                    });
                    document.getElementById('chart4_label_1').innerText = `Average Temperature: ${response.average_humid}°f`;
                    document.getElementById('chart4_label_2').innerText = `Average Humidity ${response.average_temp}%`;
                  }
                  fetch('/api/environment')
                  .then(response => response.json())
                  .then(response => {
                    renderEnvironment(response);
                    oldResponses['environment'] = JSON.stringify(response);
                  });
              </script>
              <span id="chart4_label_1" class="text-muted">Loading...</span>
              <br>
              <span id="chart4_label_2" class="text-muted">Loading...</span>
            </div>
          </div>

          <h2 class="sub-header">Events</h2>
          <div class="table-responsive">
            <table id="event_table" class="table table-striped">
              <thead>
                <tr>
                  <th>Event Id</th>
                  <th>Device Id</th>
                  <th>Temperature</th>
                  <th>Humidity</th>
                  <th>Water Level</th>
                  <th>Timestamp</th>
                </tr>
              </thead>
            </table>

            <script>

                  function renderTable(response) {
                    const table = document.getElementById('event_table');

                    // clear the table of existing rows
                    while(table.rows.length > 0) {
                      table.deleteRow(-1);
                    }

                    // populate table body
                    // https://www.valentinog.com/blog/html-table/
                    for (let element of response.events) {
                      let row = table.insertRow();
                      for (let key in element) {
                        let cell = row.insertCell();
                        let str = element[key];

                        if(key === 'timestamp') {
                          str = new Date(str).toLocaleTimeString('en-US', { year: "numeric", month: "long", day: "numeric" });
                        }
                        let text = document.createTextNode(str);
                        cell.appendChild(text);
                      }
                    }
                  }
                fetch('/api/events')
                  .then(response => response.json())
                  .then(response => {
                    renderTable(response);
                    oldResponses['events'] = JSON.stringify(response);
                });
            </script>
          </div>
        </div>
      </div>
    </div>
    <script>
      (async () => {
        // register service worker
        if ('serviceWorker' in navigator) {
          const register = await navigator.serviceWorker.register('/service-worker.js', {scope: '/'});

          // set up push notifications
          const publicVapidKey = 'BOHr4xEmTVK66CJqTttH0qi0qYwkAqf1Ck6yxGaegCRI8CMTrtFZBVhB2Lvw9K7ehnTSrPEIADF2kNbQ_lC3lMY';
          function urlBase64ToUint8Array(base64String) {
            const padding = "=".repeat((4 - base64String.length % 4) % 4);
            const base64 = (base64String + padding)
              .replace(/\-/g, "+")
              .replace(/_/g, "/");
          
            const rawData = window.atob(base64);
            const outputArray = new Uint8Array(rawData.length);
          
            for (let i = 0; i < rawData.length; ++i) {
              outputArray[i] = rawData.charCodeAt(i);
            }
            return outputArray;
          }


          await register.pushManager.subscribe({
            userVisibleOnly: true,

            //public vapid key
            applicationServerKey: urlBase64ToUint8Array(publicVapidKey)
          });

          console.log('Subscription successful');


          //Send push notification
          await fetch("/subscribe", {
              method: "POST",
              body: JSON.stringify(await register.pushManager.getSubscription()),
              headers: {
                  "content-type": "application/json"
              }
          });
        }

      })();

      // object gets hoisted up and populated above
      var oldResponses = {};

      // update the response
      console.log(oldResponses);
      setInterval(() => {
        fetch('/api/daily')
          .then(response => response.json())
          .then(response => {
            if(JSON.stringify(response) !== oldResponses['daily']) {
              renderDaily(response);
              oldResponses['daily'] = JSON.stringify(response);
            }
        });
        fetch('/api/weekly')
          .then(response => response.json())
          .then(response => {
            if(JSON.stringify(response) !== oldResponses['weekly']) {
              renderWeekly(response);
              oldResponses['weekly'] = JSON.stringify(response);
            }
        });
        fetch('/api/monthly')
          .then(response => response.json())
          .then(response => {
            if(JSON.stringify(response) !== oldResponses['monthly']) {
              renderMonthly(response);
              oldResponses['monthly'] = JSON.stringify(response);
            }
        });
        fetch('/api/environment')
          .then(response => response.json())
          .then(response => {
            if(JSON.stringify(response) !== oldResponses['environment']) {
              renderEnvironment(response);
              oldResponses['environment'] = JSON.stringify(response);
            }
        });
        fetch('/api/events')
          .then(response => response.json())
          .then(response => {
            if(JSON.stringify(response) !== oldResponses['events']) {
              renderTable(response);
              oldResponses['events'] = JSON.stringify(response);
            }
        });
      }, 2000);


    </script>

    <script src="https://code.jquery.com/jquery-1.12.4.min.js" integrity="sha384-nvAa0+6Qg9clwYCGGPpDQLVpLNn0fRaROjHqs13t4Ggj3Ez50XnGQqc/r8MhnRDZ" crossorigin="anonymous"></script>
    <script>window.jQuery || document.write('<script src="../../assets/js/vendor/jquery.min.js"><\/script>')</script>

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/js/bootstrap.min.js" integrity="sha384-aJ21OjlMXNL5UyIl/XNwTMqvzeRMZH2w8c5cRVpzpU8Y5bApTppSuUkhZXN0VxHd" crossorigin="anonymous"></script>

  </body>
</html>

